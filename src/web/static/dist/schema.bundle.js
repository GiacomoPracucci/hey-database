const e=new class{async request(e,t={}){try{const a={headers:{"Content-Type":"application/json"}},s=await fetch(e,{...a,...t}),n=await s.json();if(!s.ok)throw new Error(n.error||"Si Ã¨ verificato un errore");return n}catch(t){throw console.error(`API Error (${e}):`,t),t}}get(e){return this.request(e)}post(e,t){return this.request(e,{method:"POST",body:JSON.stringify(t)})}};const t=new class{constructor(){this.endpoints={metadata:"/schema/api/metadata"},this._schemaMetadata=null}async getSchemaMetadata(){if(this._schemaMetadata)return this._schemaMetadata;const t=await e.get(this.endpoints.metadata);if(t.success)return this._schemaMetadata=this.formatSchemaData(t.data),this._schemaMetadata;throw new Error("Errore nel recupero dei metadati dello schema")}formatSchemaData(e){const t=[];return e.tables.forEach((e=>{const a={...e};a.columns&&(a.columns=a.columns.map((t=>({...t,isForeignKey:this.isColumnForeignKey(t.name,e.relationships)})))),t.push({group:"nodes",data:{id:e.name,tableData:a},classes:["table-node"]}),Array.isArray(e.relationships)&&e.relationships.forEach(((a,s)=>{t.push({group:"edges",data:{id:`edge-${e.name}-${a.toTable}-${s}`,source:e.name,target:a.toTable,relationship:a.type,fromColumns:a.fromColumns,toColumns:a.toColumns}})}))})),{elements:t}}isColumnForeignKey(e,t){return!!Array.isArray(t)&&t.some((t=>t.fromColumns.includes(e)))}calculateOptimalLayout(e){return e.elements.filter((e=>"nodes"===e.group)).length>10?{name:"dagre",rankDir:"TB",rankSep:100,nodeSep:80,padding:50}:{name:"cose",idealEdgeLength:150,nodeOverlap:20,refresh:20,padding:30,randomize:!1,componentSpacing:150,nodeRepulsion:4e5,edgeElasticity:100,nestingFactor:5,gravity:80,numIter:1e3}}async getTableDetails(e){const t=await this.getSchemaMetadata(),a=t.elements.find((t=>"nodes"===t.group&&t.data.id===e));if(!a)throw new Error(`Tabella ${e} non trovata`);const s=t.elements.filter((t=>"edges"===t.group&&(t.data.source===e||t.data.target===e))).map((t=>({type:t.data.source===e?"outgoing":"incoming",from:t.data.source,to:t.data.target,fromColumns:t.data.fromColumns,toColumns:t.data.toColumns})));return{...a.data.tableData,relationships:s}}async findTablePaths(e,t){const a=await this.getSchemaMetadata(),s=[],n=new Set,o=(e,i=[])=>{if(e===t)return void s.push([...i,e]);n.add(e);const r=a.elements.filter((t=>"edges"===t.group&&(t.data.source===e||t.data.target===e)));for(const t of r){const a=t.data.source===e?t.data.target:t.data.source;n.has(a)||o(a,[...i,e])}n.delete(e)};return o(e),s}};if(!window.cytoscape)throw new Error("Cytoscape library not loaded");if(!window.dagre)throw new Error("Dagre library not loaded");if(!customElements.get("schema-details-panel"))throw new Error("Schema details panel component not registered");class a{constructor(){this.schemaViewer=document.getElementById("schemaViewer"),this.searchInput=document.getElementById("schemaSearch"),this.zoomInBtn=document.getElementById("zoomIn"),this.zoomOutBtn=document.getElementById("zoomOut"),this.zoomFitBtn=document.getElementById("zoomFit"),this.cy=null,this.currentTableDetails=null,this.handleSearch=this.debounce(this.handleSearch.bind(this),300),this.handleTableSelect=this.handleTableSelect.bind(this),this.handleDetailsClose=this.handleDetailsClose.bind(this),this.initialize()}async initialize(){this.showLoadingIndicator();try{cytoscape.use(window.cytoscapeDagre),await this.initializeCytoscape(),this.setupEventListeners(),await this.loadSchemaData()}catch(e){console.error("Error initializing schema page:",e),this.showError("Failed to load schema data")}finally{this.hideLoadingIndicator()}}async initializeCytoscape(){this.cy=cytoscape({container:this.schemaViewer,style:this.getCytoscapeStyles(),wheelSensitivity:.2,minZoom:.2,maxZoom:3})}getCytoscapeStyles(){return[{selector:"node",style:{"background-color":"#ffffff","border-width":1,"border-color":"#e2e8f0","border-opacity":1,shape:"roundrectangle",width:"label",height:"label",padding:"20px","text-wrap":"wrap","text-max-width":"280px","text-valign":"center","text-halign":"center","font-family":"ui-monospace, monospace","font-size":"14px",color:"#0f172a","text-margin-y":5,"compound-sizing-wrt-labels":"include","min-width":"200px","min-height":"50px","corner-radius":"8px"}},{selector:"edge",style:{width:1.5,"line-color":"#94a3b8","line-style":"dashed","curve-style":"bezier","target-arrow-color":"#94a3b8","target-arrow-shape":"triangle","arrow-scale":1}},{selector:".highlighted",style:{"border-color":"#3b82f6","border-width":2,"background-color":"#f8fafc"}}]}setupEventListeners(){this.searchInput.addEventListener("input",this.handleSearch),this.searchInput.addEventListener("keydown",(e=>{"Escape"===e.key&&(this.searchInput.value="",this.handleSearch())})),this.zoomInBtn.addEventListener("click",(()=>this.handleZoom("in"))),this.zoomOutBtn.addEventListener("click",(()=>this.handleZoom("out"))),this.zoomFitBtn.addEventListener("click",(()=>this.handleZoom("fit"))),this.cy.on("tap","node",(e=>this.handleTableSelect(e.target.id()))),this.cy.on("mouseover","node",(e=>this.highlightRelatedNodes(e.target,!0))),this.cy.on("mouseout","node",(e=>this.highlightRelatedNodes(e.target,!1)))}async loadSchemaData(){const e=await t.getSchemaMetadata();this.cy.add(e.elements);const a=this.cy.layout({name:"dagre",rankDir:"TB",rankSep:100,nodeSep:80,padding:50,animate:!0,animationDuration:500});await a.run(),this.cy.fit(50),this.cy.center()}async handleTableSelect(e){try{const a=await t.getTableDetails(e);this.currentTableDetails&&this.currentTableDetails.remove(),this.currentTableDetails=document.createElement("schema-details-panel"),this.currentTableDetails.setAttribute("table-name",e),this.currentTableDetails.columns=a.columns,this.currentTableDetails.relationships=a.relationships,this.currentTableDetails.addEventListener("close",this.handleDetailsClose),document.querySelector(".schema-container").appendChild(this.currentTableDetails)}catch(e){console.error("Error loading table details:",e),this.showError("Failed to load table details")}}handleDetailsClose(){this.currentTableDetails&&(this.currentTableDetails.remove(),this.currentTableDetails=null)}handleSearch(){const e=this.searchInput.value.toLowerCase().trim();if(!e)return void this.cy.elements().removeClass("faded highlighted search-match");const t=this.cy.nodes().filter((t=>{const a=t.data("tableData");return!!a&&(a.name.toLowerCase().includes(e)||a.columns.some((t=>t.name.toLowerCase().includes(e)||t.type.toLowerCase().includes(e))))}));if(t.length>0){this.cy.elements().addClass("faded"),t.removeClass("faded").addClass("search-match");t.edgesWith(t).removeClass("faded"),this.cy.animate({fit:{eles:t,padding:50},duration:500})}}handleZoom(e){switch(e){case"in":this.cy.animate({zoom:1.2*this.cy.zoom(),duration:200});break;case"out":this.cy.animate({zoom:this.cy.zoom()/1.2,duration:200});break;case"fit":this.cy.animate({fit:{padding:50},duration:300})}}highlightRelatedNodes(e,t){const a=e.connectedEdges(),s=a.connectedNodes();t?(this.cy.elements().difference(a.union(s).union(e)).addClass("faded"),a.addClass("highlighted"),s.addClass("highlighted")):this.cy.elements().removeClass("faded highlighted")}showLoadingIndicator(){const e=document.getElementById("loadingIndicator");e&&(e.style.display="flex")}hideLoadingIndicator(){const e=document.getElementById("loadingIndicator");e&&(e.style.display="none")}showError(e){if(!customElements.get("toast-notification"))return console.error("Toast notification component not registered"),void alert(e);const t=document.createElement("toast-notification");t.setAttribute("type","error"),t.setAttribute("message",e),document.body.appendChild(t)}debounce(e,t){let a;return function(...s){clearTimeout(a),a=setTimeout((()=>{clearTimeout(a),e(...s)}),t)}}}document.addEventListener("DOMContentLoaded",(()=>{new a}));
//# sourceMappingURL=schema.bundle.js.map
